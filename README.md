## Todolist REST API
---

### Introduction

This software was written solely in Go and provides a simple REST API to manage ToDos with CRUD operations. For each ToDo different tasks can be added. The application supports basic auth with api key. Input JSON are validated and strings like name or description get sanitized before storage. For Storage Postgres is used. However, also another database can be used with only slight adjustment as database access is abstract with the GORM ORM that supports different relational databases.

### Key Dependencies
- [Go](https://golang.org): This project uses Go to create a reliable, fast and efficient todolist REST API.
- [GORM](https://gorm.io): This project uses the GORM go ORM to abstract the database and allow simple and reliable database access.
- [PostgreSQL](https://www.postgresql.org): Postgres is used as SQL database of choice.
- [Mux](https://github.com/gorilla/mux): As router gorilla mux is used.

## Installation
---

The repository is already prepared for deployment on heroku and different options are provided to run the todolist API locally.

## Local
The Docker-Compose.yml, multi-stage Dockerfile, Visual Studio Code Workspace or just the go sources and module can be used to run the todolist REST API locally. Depending on which solution is chosen and your Postgres Settings please adjust the ```.env``` / ```Dockerfile``` file accordingly.

1. #### Debug
    To debug the todolist REST API it is recommended to install Visual Studio Code and open the provided todolist.code-workspace. Note: Before running any code, please type ```source .env```

1. #### Binary
    It is also possible to just use ```go build``` and run the binary. Note: Before running any code, please type ```source .env```

3. #### Docker-Compose
    To run the todolist REST API as Docker container, feel free to use the provided ```docker-compose.yml```. It also generates a PostgreSQL docker image that can be used as database. Otherwise the corresponding container can be deactivated after build and a local or online Postgres solution can be used. Ideally adjust ```Dockerfile``` with correct environment variables based on the Postgres settings before compose. Run the following command to create the docker containers: 
    ```
    docker-compose -f docker-compose.yml up
    ```

4. #### Dockerfile
    To use a already existing local or online PostgreSQL installation you can directly use the ```multi-stage Dockerfile```. The multi-stage Dockerfile specifies build stage with a full-fledged golang image and copies the static binary into a minimalistic docker container with minimal resource usage and without shell for production! Note: Before compose, adjust ```Dockerfile``` with correct environment variables based on the Postgres settings. Run the following command to create the docker image: 
    ```
    docker build .
    ```

## Deployment
The todolist REST API is already deployed on Heroku and reachable under the url provided in the todolist_heroku.postman_environment.json: https://todolist-koch.herokuapp.com

The following steps are necessary to deploy the todolist on heroku yourself:
1. Create new app on Heroku
2. Chose deployment with heroku git
3. Ideally test Dockerfile locally first
4. Add Heroku Postgres as Add-On in Heroku
5. Copy Heroku Postgres Info into ENV variables in Dockerfile and heroku.yml. environment Variable PORT will be generated by heroku and overwrites setting in Docker container.
6. Install heroku CLI and run the following commands:
7. $ heroku login
8. $ heroku git:remote -a <heroku_app_name>
9. $ heroku stack:set container
10. $ git push heroku main

The deployment is started automatically by pushing the repository to the git of the heroku app.

Note: The heroku.yml also allows to define a realease phase. The release phase allows testing your docker build before deployment. If the test in the release phase fails the docker container will not be deployed. For future version a release phase could be added to further improve the deployment process.

## Testing
---

The Go REST API software can be tested with the provided Go unittest. Additionally a postman collection is provided that can be used to test the local installation or the deployed endpoint in the release phase or in production.

### 1. Unittest
The unittest allows quick testing of the provided golang code during development and automatic testing during deployment. With the provided Visual Studio Workspace it is also possible to debug the unittest.

Currently 58 tests are run that cover most parts of the software. In the future further tests can be added to also trigger some of the more exotic error cases. To get a detailed overview of the code coverage please run:
```
go test -coverprofile=coverage.out
go tool cover -html=coverage.out
```

### 1. Postman
A Postman collection is provided to test the endpoints. The Postman collection allows to test the todolist REST API locally, as well as in the release stage or in production by adjusting the ```domain``` Postman environment variable. For testing over the command line install Newman. Newman also allows automated testing.

Note: The ```key``` Postman collection variable must match with the .env file and the heroku.yml / Dockerfile. The ```domain``` Postman environment variable must match with the domain of the corresponding todolist REST API!

To run the tests in postman import the provided collection and the provided environments. The provided postman collection and postman heroku environment can also be used to test the already deployed solution.

To run the postman collection with newman, please type the following command for the already deployed Heroku todolist REST API:
```
newman run todolist.postman_collection.json -e todolist_heroku.postman_environment.json
```

To run the postman collection with newman to test locally or another deployment adjust the domain env var with the following command:
```
newman run url.postman_collection.json --env-var "domain=http://localhost:8000"
```

## Controllers / Routes
---
Todolist REST API Controllers / Routes.

Note: All Routes expect an api key for basic auth. The api key can be configured in the ```TODOLIST_API_KEY``` env variable. For future version a list of api keys could be implemented. However, this would also require an additional API to provide and manage the API KEYs for different clients.

## GET index
```
GET /
```
Soft redirect to GET /todos

## GET todos
```
GET /todos
```
Returns a JSON with a complete list of todos and theire tasks.

Example response JSON:
```
[
    {
        "id": 16,
        "name": "todolist go REST API",
        "description": "write a REST API in go for a simple todo list. Each todo can have multiple subtodos called tasks",
        "tasks": [
            {
                "id": 88,
                "name": "Create Server",
                "description": "Create Server according to specs with go"
            },
            {
                "id": 89,
                "name": "Unittest",
                "description": "Build Unittest for go server"
            },
            {
                "id": 90,
                "name": "Docker",
                "description": "create docker container with go server"
            },
            {
                "id": 91,
                "name": "Postman",
                "description": "create postman test for docker container"
            },
            {
                "id": 92,
                "name": "Documentation",
                "description": "write markdown documentation that describes installation, API, models, dependencies, deployment and so on"
            }
        ]
    },
    {
        "id": 17,
        "name": "todolist go REST API",
        "description": "write a REST API in go for a simple todo list. Each todo can have multiple subtodos called tasks",
        "tasks": [
            {
                "id": 93,
                "name": "Create Server",
                "description": "Create Server according to specs with go"
            },
            {
                "id": 94,
                "name": "Unittest",
                "description": "Build Unittest for go server"
            },
            {
                "id": 95,
                "name": "Docker",
                "description": "create docker container with go server"
            },
            {
                "id": 96,
                "name": "Postman",
                "description": "create postman test for docker container"
            },
            {
                "id": 97,
                "name": "Documentation",
                "description": "write markdown documentation that describes installation, API, models, dependencies, deployment and so on"
            }
        ]
    }
]
```

## POST todos
```
POST /todos
```
Expects a JSON with a todo that may have multiple tasks. However, the JSON shall not include any "id" fields!

Example request JSON:
```
{
    "name" : "todolist go REST API",
    "description" : "write a REST API in go for a simple todo list. Each todo can have multiple subtodos called tasks",
    "tasks":[
        {
            "name" : "Create Server",
            "description" : "Create Server according to specs with go"
        },
        {
            "name" : "Unittest",
            "description" : "Build Unittest for go server"
        },
        {
            "name" : "Docker",
            "description" : "create docker container with go server"
        },
        {
            "name" : "Postman",
            "description" : "create postman test for docker container"
        },
        {
            "name" : "Documentation",
            "description" : "write markdown documentation that describes installation, API, models, dependencies, deployment and so on"
        }
    ]
}
```

Returns a JSON with the todo that was provided in the POST request with the corresponding "id" fields for the todo and the tasks.

Example response JSON:
```
{
    "id": 16,
    "name": "todolist go REST API",
    "description": "write a REST API in go for a simple todo list. Each todo can have multiple subtodos called tasks",
    "tasks": [
        {
            "id": 88,
            "name": "Create Server",
            "description": "Create Server according to specs with go"
        },
        {
            "id": 89,
            "name": "Unittest",
            "description": "Build Unittest for go server"
        },
        {
            "id": 90,
            "name": "Docker",
            "description": "create docker container with go server"
        },
        {
            "id": 91,
            "name": "Postman",
            "description": "create postman test for docker container"
        },
        {
            "id": 92,
            "name": "Documentation",
            "description": "write markdown documentation that describes installation, API, models, dependencies, deployment and so on"
        }
    ]
}
```

## GET todo
```
GET /todos/{id}
```
Returns a JSON with the todo for the "id" provided in the request url.

Example response JSON:
```
{
    "id": 16,
    "name": "todolist go REST API",
    "description": "write a REST API in go for a simple todo list. Each todo can have multiple subtodos called tasks",
    "tasks": [
        {
            "id": 88,
            "name": "Create Server",
            "description": "Create Server according to specs with go"
        },
        {
            "id": 89,
            "name": "Unittest",
            "description": "Build Unittest for go server"
        },
        {
            "id": 90,
            "name": "Docker",
            "description": "create docker container with go server"
        },
        {
            "id": 91,
            "name": "Postman",
            "description": "create postman test for docker container"
        },
        {
            "id": 92,
            "name": "Documentation",
            "description": "write markdown documentation that describes installation, API, models, dependencies, deployment and so on"
        }
    ]
}
```

## PUT todo
```
PUT /todos/{id}
```
Overwrites a todo with the todo provided in the JSON. The JSON shall include the "id" field for the todo. If no "id" field is provided for a task, this task is added as a new task for this todo. If a "id" field is provided the exiting task will be overwritten with the corresponding task provided in the JSON.

Example request JSON:
```
{
    "id": 16,
    "CreatedAt": "2021-04-30T00:00:21.093101+02:00",
    "UpdatedAt": "2021-04-30T00:00:21.093101+02:00",
    "DeletedAt": null,
    "name": "todolist go REST API finalization",
    "description": "write a REST API in go for a simple todo list. Each todo can have multiple subtodos called tasks",
    "tasks": [
        {
            "name": "Continous Integration",
            "description": "add automatic unitest before deployment"
        }
    ]
}
```

Returns a JSON with the todo that was provided in the POST request with the corresponding "id" fields for the todo and the tasks.

Example response JSON:
```
{
    "id": 16,
    "name": "todolist go REST API finalization",
    "description": "write a REST API in go for a simple todo list. Each todo can have multiple subtodos called tasks",
    "tasks": [
        {
            "id": 88,
            "name": "Create Server",
            "description": "Create Server according to specs with go"
        },
        {
            "id": 89,
            "name": "Unittest",
            "description": "Build Unittest for go server"
        },
        {
            "id": 90,
            "name": "Docker",
            "description": "create docker container with go server"
        },
        {
            "id": 91,
            "name": "Postman",
            "description": "create postman test for docker container"
        },
        {
            "id": 92,
            "name": "Documentation",
            "description": "write markdown documentation that describes installation, API, models, dependencies, deployment and so on"
        },
        {
            "id": 98,
            "name": "Continous Integration",
            "description": "add automatic unitest before deployment"
        }
    ]
}
```

## DELETE todo
```
DELETE /todos/{id}
```
Soft deletes the todo with the "id" provided in the request url and returns the deleted todo.

Note: Soft deleted todos are no longer accessible with the usual todolist REST API routes but can be viewed with database tooling until permanently deleted with DELETE /todos.

Example response JSON:
```
{
    "id": 16,
    "name": "todolist go REST API finalization",
    "description": "write a REST API in go for a simple todo list. Each todo can have multiple subtodos called tasks",
    "tasks": [
        {
            "id": 88,
            "name": "Create Server",
            "description": "Create Server according to specs with go"
        },
        {
            "id": 89,
            "name": "Unittest",
            "description": "Build Unittest for go server"
        },
        {
            "id": 90,
            "name": "Docker",
            "description": "create docker container with go server"
        },
        {
            "id": 91,
            "name": "Postman",
            "description": "create postman test for docker container"
        },
        {
            "id": 92,
            "name": "Documentation",
            "description": "write markdown documentation that describes installation, API, models, dependencies, deployment and so on"
        },
        {
            "id": 98,
            "name": "Continous Integration",
            "description": "add automatic unitest before deployment"
        }
    ]
}
```

## DELETE todos
```
DELETE /todos/{id}
```
Permanently deletes only todos marked with soft delete. Todos that were not soft deleted yet, are not affected. Returns the permanently deleted todos.

Example response JSON:
```
[
    {
        "id": 16,
        "name": "todolist go REST API finalization",
        "description": "write a REST API in go for a simple todo list. Each todo can have multiple subtodos called tasks",
        "tasks": [
            {
                "id": 88,
                "name": "Create Server",
                "description": "Create Server according to specs with go"
            },
            {
                "id": 89,
                "name": "Unittest",
                "description": "Build Unittest for go server"
            },
            {
                "id": 90,
                "name": "Docker",
                "description": "create docker container with go server"
            },
            {
                "id": 91,
                "name": "Postman",
                "description": "create postman test for docker container"
            },
            {
                "id": 92,
                "name": "Documentation",
                "description": "write markdown documentation that describes installation, API, models, dependencies, deployment and so on"
            },
            {
                "id": 98,
                "name": "Continous Integration",
                "description": "add automatic unitest before deployment"
            }
        ]
    }
]
```